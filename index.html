<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <table class="table">
        <tr>
            <td id="header1"><p>Kişiler</p></td>
            <td id="header2"><p>Detayları Görmek için Sürükle↓</p></td>
            <td id="header3"><p>Detaylar</p></td>
        </tr>
        <th id="box1" ondrop="drop(event)" ondragover="dropAble(event)"></th>
        <th id="box2" ondrop="drop(event)" ondragover="dropAble(event)"></th>
        <th id="box3" ondrop="drop(event)" ondragover="dropAble(event)"></th>
    </table>

    <form action="/addCard" method="POST" class="addForm">
        <input type="text" class="textInput" name="name" placeholder="İsim" required>
        <br>
        <input type="text" class="textInput" name="surname" placeholder="Soyisim" required>
        <br>
        <input type="text" class="textInput" name="email" placeholder="Email" required>
        <br>
        <input type="radio" id="radio1" class="radiobutton"  name="bolumid" value="1" required checked>
        <label for="radio1">Yazılım Müh.</label>
        <br>
        <input type="radio" id="radio2" class="radiobutton"  name="bolumid"  value="2">
        <label for="radio2">Bilgisayar Müh.</label>
        <br>
        <input type="radio" id="radio3" class="radiobutton"  name="bolumid"  value="3">
        <label for="radio3">Elektrik-Elektronik Müh.</label>
        <br>
        <input type="submit" value="+" class="addButton" >
    </form>


    <div  id="delete" ondrop="deleteItem(event)" ondragover="dropAble(event)" class="deleteitem"></div>

    
    

    <script>
        checkFilled();
        function deleteItem(ev)
        {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("text");
            deleteSend(data);
        }

        async function deleteSend( data) {
            try {
                const response = await fetch('/delete-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: data })
                });
                const result = await response.text();
                console.log('Success:', result);
                location.reload();
            } catch (error) {
                console.error('Error:', error);
            }
        }



        function dropAble(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        async function drop(ev) {
            let targetbox = ev.target;
            ev.preventDefault();
            var data = ev.dataTransfer.getData("text");
            let box2 = document.getElementById("box2");
            if(targetbox.id == "delete")
            {
                console.log("dropped");
                deleteData(data);
                if(!box2.hasChildNodes())
                {
                    changeFilled();
                }
            }
            else if(targetbox.id == "box1")
            {
                targetbox.appendChild(document.getElementById(data));
                postData(1, data);
                if(!box2.hasChildNodes())
                {
                    changeFilled();
                }
            }
            
            else if(targetbox.id === "box2" && filledOut)
            {
                targetbox.appendChild(document.getElementById(data));
                postData(2, data);
                changeFilled();
                console.log("moved to box2");
                detailsFunction();
            }
            
            
            
        }

        let filledOut = true;
        function checkFilled() {
            fetch('/check-filled')
                .then(response => response.json())
                .then(data => {
                    const filled = data.filled;
                    console.log(filled); // true or false
                    filledOut = !filled;
                    detailsFunction();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function changeFilled() {
            fetch('/change-filled')
                .then(response => response.text())
                .then(message => {
                    console.log(message); // Log the server response
                    checkFilled();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        async function postData(bolumid, data) {
            try {
                const response = await fetch('/change-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ bolumid: bolumid, data: data })
                });
                const result = await response.text();
                console.log('Success:', result);
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        fetch('/data')
            .then(response => response.json())
            .then(data => {
                const boxes = ["box1", "box2"];
                data.forEach((person, index) => {
                    const card = document.createElement('div');
                    card.className = 'drag';
                    card.draggable = true;
                    card.id = "drag"+(index + 1);
                    card.setAttribute("ondragstart", "drag(event)");
                    card.innerHTML = `
                        <p>
                            <span>Ad:</span>
                            <span>${person.name}</span>
                        </p>
                        <p>
                            <span>Soyad:</span>
                            <span>${person.surname}</span>
                        </p>
                        <p>
                            <span>Email:</span>
                            <span>${person.email}</span>
                        </p>
                    `;
                    switch (person.bolumid) {
                        case 1:
                            document.getElementById("box1").appendChild(card);
                            break;
                        case 2:
                            document.getElementById("box2").appendChild(card);
                            break;
                    }
                });
            })
            .catch(error => console.error('Error:', error));

            


        function detailsFunction () {
            fetch('/detail-data')
            .then(response => response.json())
            .then(data => {
                
                data.forEach((person, index) => {
                if(person.filled)
                    {
                    const card = document.createElement('div');
                    card.className = "details";
                    card.innerHTML = `
                    <h3>  ${person.name} ${person.surname}</h3>
                    <p>Bölüm: ${person.area}</p>
                    <p>${person.email}</p>
                    <p>Ofis: ${person.office}</p>
                    <p>Tel: ${person.number}</p>
                    `;

                    const box = document.getElementById("box3");

                    box.innerHTML = '';

                    box.appendChild(card);
                    } 
                else if(!person.filled)
                {
                    document.getElementById("box3").innerHTML = '';
                }      
                });
            })
            .catch(error => console.error('Error:', error));
        }
        
    </script>
</body>
</html>
